name: Build and Deploy-Dev

on:
  push:
    branches:
      - main
    paths:
      - 'bots/**'
      - 'libraries/**'
      - 'services/**'
      # since now dev and prod is connected to each other so I will build it even if prod yml change
      - '.github/workflows/**'


      #Bot_Models_0eea0b06a49abee087bcfaa3058d61068d9bff55

concurrency:
  group: SSWSophieBotDev-BuildAndDeploy
  cancel-in-progress: true

env:
  BUILD_FLOW: composer
  BOT_NAME: SSWSophieBotDev
  WEBAPP_NAME: SSWSophieBotDev
  SOURCE_DIR: ${{ github.workspace }}
  OUTPUT_DIR: ${{ github.workspace }}/output
  LUIS_MIGRATOR_DIR: ${{ github.workspace }}/bots/employee-finder/src/SSW.SophieBot.LUIS.EmployeeFinder.Migrator
  BOT_PROJECT_DIR: ${{ github.workspace }}/bots/employee-finder/src/SSW.SophieBot
  BOT_PROJECT_NAME: SSW.SophieBot.csproj
  PUBLISHING_PROFILE_NAME: SSW.Bots.Dev
  LUIS_AUTHORING_ENDPOINT: https://australiaeast.api.cognitive.microsoft.com/
  LUIS_AUTHORING_REGION: australiaeast
  ENVIRONMENT_NAME_DEV: development
  ENVIRONMENT_NAME_PROD: production

defaults:
  run:
    shell: pwsh

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    environment: dev
    steps:
      - uses: actions/checkout@v2.3.4

      - id: setup 
        uses: duanxinhuan/SSW.SophieBot/actions/set-up@v3.2
        with: 
          bot-app-setting: ${{ secrets.BOT_APP_APPSETTINGS }}
          luis-key: ${{secrets.LUIS_AUTHORING_KEY}}
          environment-value: ${{env.ENVIRONMENT_NAME_DEV}}


  deploy-web-app:
    name: Deploy web app
    needs: build
    runs-on: ubuntu-latest
    environment: dev
    steps:
      - uses: actions/checkout@v2.3.4
      - id: deploy-web 
        uses: duanxinhuan/SSW.SophieBot/actions/deploy-web@v3.2
        with: 
          bot-web-publish-profile: ${{ secrets.BOT_WEBAPP_PUBLISH_PROFILE }}
      

  migrate-luis-model:
    name: Migrate LUIS model
    needs: build 
    runs-on: windows-latest
    environment: dev
    steps:
      - uses: actions/checkout@v2.3.4

      - uses: duanxinhuan/SSW.SophieBot/actions/migrate-LUIS@v3.2
        with: 
          luis-app-setting: ${{ secrets.LUIS_MIGRATOR_APPSETTINGS }}

  build-prod:
    name: Build product
    needs: [deploy-web-app,migrate-luis-model]      
    runs-on: ubuntu-latest  
    environment: prod
    steps:
      - uses: trstringer/manual-approval@v1
        with:
          secret: ${{ github.TOKEN }}
          approvers: duanxinhuan,jimmidier
      - uses: actions/checkout@v2.3.4
      - id: setup 
        uses: duanxinhuan/SSW.SophieBot/actions/set-up@v3.2
        with: 
          bot-app-setting: ${{ secrets.BOT_APP_APPSETTINGS }}
          luis-key: ${{secrets.LUIS_AUTHORING_KEY}}
          environment-value: ${{env.ENVIRONMENT_NAME_PROD}}

  deploy-web-app-prod:
    name: Deploy web app on production
    needs: build-prod
    runs-on: ubuntu-latest
    environment: prod
    steps:
      - uses: actions/checkout@v2.3.4
      - id: deploy-web 
        uses: duanxinhuan/SSW.SophieBot/actions/deploy-web@v3.2
        with: 
          bot-web-publish-profile: ${{ secrets.BOT_WEBAPP_PUBLISH_PROFILE }}
      

  migrate-luis-model-prod:
    name: Migrate LUIS model on production
    needs: build-prod
    runs-on: windows-latest
    environment: prod
    steps:
      - uses: actions/checkout@v2.3.4

      - uses: duanxinhuan/SSW.SophieBot/actions/migrate-LUIS@v3.2
        with: 
          luis-app-setting: ${{ secrets.LUIS_MIGRATOR_APPSETTINGS }}
